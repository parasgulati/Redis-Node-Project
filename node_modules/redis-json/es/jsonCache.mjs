/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */
function e(e,t,i,n){return new(i||(i=Promise))((function(s,r){function l(e){try{c(n.next(e))}catch(e){r(e)}}function o(e){try{c(n.throw(e))}catch(e){r(e)}}function c(e){e.done?s(e.value):new i((function(t){t(e.value)})).then(l,o)}c((n=n.apply(e,t||[])).next())}))}const t={undefined:!0,null:!0,false:!0,true:!0};function i(e,n="",s={}){return Object.entries(e).forEach(([e,r])=>{!function e(n,s,r){const l=Array.isArray(n);n instanceof Object&&!l?0===Object.keys(n).length?r[s]="{}":i(n,s,r):l?0===n.length?r[s]="[]":n.forEach((t,i)=>{e(t,`${s}.${i}`,r)}):r[s]=t[n]?n+"":n}(r,n?`${n}.${e}`:e,s)}),s}const n={"{}":()=>({}),"[]":()=>[],undefined:()=>void 0,null:()=>null,true:()=>!0,false:()=>!1};function s(e){const t=Number(e);return isNaN(t)?e:t}export default class{constructor(e,t={}){this.redisClient=e,this.options=t,this.options.prefix=t.prefix||"jc:"}set(t,n,s={}){return e(this,void 0,void 0,(function*(){const e=i(n);e.__jc_root__="0",yield this.redisClient.hmset.call(this.redisClient,this.getKey(t),e),s.expire&&(yield this.redisClient.expire.call(this.redisClient,this.getKey(t),s.expire))}))}get(t,...i){return e(this,void 0,void 0,(function*(){const e=yield this.redisClient[i.length>0?"hmget":"hgetall"].call(this.redisClient,this.getKey(t),...i);if(0!==Object.keys(e).length)return delete e.__jc_root__,i.length>0?i.reduce((t,i,n)=>(t[i]=e[n],t),{}):function(e){const t={};return Object.entries(e).forEach(([e,i])=>{const r=e.split(".");let l=0,o=s(r[l]),c=s(r[l+1]),h=t;for(;void 0!==c;){h[o]instanceof Object||(h[o]="number"==typeof c?[]:{}),h=h[o],++l<r.length&&(o=s(r[l]),c=s(r[l+1]))}h[o]=n[i]?n[i]():i}),t}(e)}))}rewrite(t,i){return e(this,void 0,void 0,(function*(){yield this.redisClient.del.call(this.redisClient,this.getKey(t)),yield this.set(t,i)}))}clearAll(){return e(this,void 0,void 0,(function*(){const e=yield this.redisClient.keys.call(this.redisClient,`${this.options.prefix}*`);yield this.redisClient.multi(e.map(e=>["del",e])).exec()}))}getKey(e){return`${this.options.prefix}${e}`}}
